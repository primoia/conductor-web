<div class="agent-game-container">
  <!-- Agent Game Toolbar -->
  <div class="agent-game-toolbar">
    <div class="toolbar-left">
      <!-- View Mode Controls -->
      <div class="view-mode-controls">
        <button
          class="mode-button"
          [class.active]="viewMode === 'instances'"
          (click)="setViewMode('instances')">
          üé≠ Por Inst√¢ncia
        </button>
        <button
          class="mode-button"
          [class.active]="viewMode === 'agents'"
          (click)="setViewMode('agents')">
          ü§ñ Por Agente
        </button>
      </div>
    </div>

    <div class="toolbar-right">
      <!-- Filter Toggle Button -->
      <button
        class="mode-button filter-toggle"
        [class.active]="showFilters"
        (click)="toggleFilters()">
        üîç Filtros
      </button>
    </div>
  </div>

  <!-- Filter Controls Panel (expandable) -->
  <div class="filter-controls" *ngIf="showFilters">
    <div class="filter-header">
      <span class="filter-title">üîç Filtros</span>
      <button class="filter-close" (click)="toggleFilters()" title="Fechar (ESC)">√ó</button>
    </div>

    <div class="filter-section">
      <label class="filter-label">üîç Buscar:</label>
      <input
        type="text"
        class="filter-input"
        [(ngModel)]="filters.searchTerm"
        placeholder="Nome do agente..."
        (input)="onFilterChange()">
    </div>

    <div class="filter-section">
      <label class="filter-label">‚ö° Execu√ß√µes m√≠nimas:</label>
      <input
        type="number"
        class="filter-number"
        [(ngModel)]="filters.minExecutions"
        min="0"
        (input)="onFilterChange()">
    </div>

    <div class="filter-section">
      <label class="filter-label">üè∑Ô∏è Tipos:</label>
      <div class="filter-checkboxes">
        <label *ngFor="let type of availableAgentTypes" class="filter-checkbox">
          <input
            type="checkbox"
            [value]="type.value"
            [checked]="filters.agentTypes.includes(type.value)"
            (change)="onAgentTypeFilterChange(type.value, $event)">
          <span class="filter-checkbox-label">
            {{ type.emoji }} {{ type.label }}
          </span>
        </label>
      </div>
    </div>

    <div class="filter-section">
      <label class="filter-label">üèõÔ∏è Conselheiros:</label>
      <div class="filter-radios">
        <label class="filter-radio">
          <input
            type="radio"
            name="councilorFilter"
            value="all"
            [checked]="filters.councilorFilter === 'all'"
            (change)="onCouncilorFilterChange('all')">
          <span class="filter-radio-label">Todos</span>
        </label>
        <label class="filter-radio">
          <input
            type="radio"
            name="councilorFilter"
            value="councilors"
            [checked]="filters.councilorFilter === 'councilors'"
            (change)="onCouncilorFilterChange('councilors')">
          <span class="filter-radio-label">üèõÔ∏è Conselheiros</span>
        </label>
        <label class="filter-radio">
          <input
            type="radio"
            name="councilorFilter"
            value="regular"
            [checked]="filters.councilorFilter === 'regular'"
            (change)="onCouncilorFilterChange('regular')">
          <span class="filter-radio-label">ü§ñ Regulares</span>
        </label>
      </div>
    </div>

    <div class="filter-actions">
      <button class="filter-button" (click)="clearFilters()">
        üóëÔ∏è Limpar Filtros
      </button>
    </div>
  </div>

  <canvas
    #gameCanvas
    class="game-canvas"
    (click)="onCanvasClick($event)"
    (mousemove)="onCanvasMouseMove($event)"
    (mouseleave)="onCanvasMouseLeave($event)">
  </canvas>

  <!-- Debug Panel -->
  <div class="debug-panel" *ngIf="showDebugPanel">
    <div class="debug-header">
      <span>üêõ DEBUG PANEL</span>
      <button class="debug-close" (click)="toggleDebugPanel()">√ó</button>
    </div>
    <pre class="debug-content">{{ getDebugInfo() }}</pre>
    <div class="debug-footer">
      <small>Atualizado a cada 1s | Use toggleDebug() para fechar</small>
    </div>
  </div>

  <!-- Mini Map Hover Popup -->
  <div
    class="mini-map-popup"
    *ngIf="showMiniMapPopup && hoveredAgent"
    [style.left.px]="miniMapPopupX"
    [style.top.px]="miniMapPopupY">
    <div class="popup-header">
      <span class="popup-emoji">{{ hoveredAgent.emoji }}</span>
      <span class="popup-name">{{ hoveredAgent.name }}</span>
    </div>
    <div class="popup-metrics">
      <div class="popup-metric">
        <span class="popup-metric-label">Execu√ß√µes:</span>
        <span class="popup-metric-value">{{ hoveredAgent.executionMetrics.totalExecutions }}</span>
      </div>
      <div class="popup-metric">
        <span class="popup-metric-label">Tempo Total:</span>
        <span class="popup-metric-value">{{ formatExecutionTime(hoveredAgent.executionMetrics.totalExecutionTime) }}</span>
      </div>
      <div class="popup-metric">
        <span class="popup-metric-label">Tempo M√©dio:</span>
        <span class="popup-metric-value">{{ formatExecutionTime(hoveredAgent.executionMetrics.averageExecutionTime) }}</span>
      </div>
    </div>
  </div>

  <!-- Agent Info Modal -->
  <div class="agent-modal-overlay" *ngIf="showTooltip && selectedAgent" (click)="closeTooltip()">
    <div class="agent-modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <div class="modal-title">
          <span class="modal-emoji">{{ selectedAgent.emoji }}</span>
          <span class="modal-agent-name">{{ selectedAgent.name }}</span>
        </div>
        <button class="modal-close" (click)="closeTooltip()" title="Fechar (ESC)">√ó</button>
      </div>
      <div class="modal-body">
        <!-- Info Grid -->
        <div class="info-grid">
          <div class="info-item">
            <span class="info-label">Agent ID</span>
            <span class="info-value">{{ selectedAgent.agentId }}</span>
          </div>
          <div class="info-item" *ngIf="viewMode === 'instances'">
            <span class="info-label">Instance ID</span>
            <span class="info-value small-text">{{ selectedAgent.id }}</span>
          </div>
          <div class="info-item" *ngIf="viewMode === 'agents'">
            <span class="info-label">Inst√¢ncias</span>
            <span class="info-value">{{ getInstanceCount(selectedAgent.agentId) }}</span>
          </div>
          <div class="info-item">
            <span class="info-label">Status</span>
            <span class="info-value status" [class.active]="selectedAgent.isActive">
              {{ selectedAgent.isActive ? 'üü¢ Trabalhando' : 'üî¥ Inativo' }}
            </span>
          </div>
          <div class="info-item screenplay-item" *ngIf="viewMode === 'instances'">
            <span class="info-label">Screenplay</span>
            <a [href]="getScreenplayUrl(selectedAgent.screenplayId)" target="_blank" class="screenplay-link">
              {{ selectedAgent.screenplayId }} üîó
            </a>
          </div>
        </div>

      <!-- Se√ß√£o de M√©tricas Consolidadas (modo agente) -->
      <div class="tooltip-metrics" *ngIf="viewMode === 'agents'">
        <div class="tooltip-metrics-header">
          <h4>üìä M√©tricas Consolidadas</h4>
        </div>
        <div class="tooltip-metric">
          <span class="tooltip-metric-label">Total de Execu√ß√µes:</span>
          <span class="tooltip-metric-value">{{ getAggregatedExecutions(selectedAgent.agentId) }}</span>
        </div>
        <div class="tooltip-metric">
          <span class="tooltip-metric-label">Tempo Total:</span>
          <span class="tooltip-metric-value">{{ formatExecutionTime(getAggregatedTime(selectedAgent.agentId)) }}</span>
        </div>
        <div class="tooltip-metric">
          <span class="tooltip-metric-label">Tempo M√©dio:</span>
          <span class="tooltip-metric-value">{{ formatExecutionTime(getAggregatedTime(selectedAgent.agentId) / getAggregatedExecutions(selectedAgent.agentId)) }}</span>
        </div>
      </div>

      <!-- Lista de Inst√¢ncias (modo agente) -->
      <div class="instances-list" *ngIf="viewMode === 'agents'">
        <div class="instances-header">
          <h4>üé≠ Inst√¢ncias ({{ getInstanceCount(selectedAgent.agentId) }})</h4>
        </div>
        <div *ngFor="let instance of getInstancesForAgent(selectedAgent.agentId)"
             class="instance-item-extended">
          <div class="instance-row">
            <div class="instance-info">
              <span class="instance-id">{{ instance.id.substring(0, 8) }}...</span>
              <span class="instance-executions">{{ instance.executionMetrics.totalExecutions }} exec</span>
            </div>
            <div class="instance-status" [class.active]="instance.isActive">
              {{ instance.isActive ? 'üü¢' : 'üî¥' }}
            </div>
          </div>
          <div class="instance-screenplay">
            <span class="screenplay-icon">üé¨</span>
            <a [href]="getScreenplayUrl(instance.screenplayId)" target="_blank" class="instance-screenplay-link">
              {{ instance.screenplayId }}
            </a>
          </div>
        </div>
      </div>

      <!-- Se√ß√£o de M√©tricas de Execu√ß√£o (modo inst√¢ncia) -->
      <div class="tooltip-metrics" *ngIf="viewMode === 'instances'">
        <div class="tooltip-metrics-header">
          <div class="metrics-title">
            <i class="fas fa-chart-line"></i>
            <span>Performance</span>
          </div>
          <div class="execution-indicator" [class.executing]="selectedAgent.executionMetrics.isCurrentlyExecuting">
            <i class="fas fa-circle" [class.pulse]="selectedAgent.executionMetrics.isCurrentlyExecuting"></i>
            <span>{{ selectedAgent.executionMetrics.isCurrentlyExecuting ? 'Ativo' : 'Inativo' }}</span>
          </div>
        </div>
        
        <div class="metrics-grid">
          <div class="metric-card">
            <div class="metric-icon">
              <i class="fas fa-play-circle"></i>
            </div>
            <div class="metric-content">
              <span class="metric-value">{{ selectedAgent.executionMetrics.totalExecutions }}</span>
              <span class="metric-label">Execu√ß√µes</span>
            </div>
          </div>
          
          <div class="metric-card">
            <div class="metric-icon">
              <i class="fas fa-clock"></i>
            </div>
            <div class="metric-content">
              <span class="metric-value">{{ formatExecutionTime(selectedAgent.executionMetrics.totalExecutionTime) }}</span>
              <span class="metric-label">Tempo Total</span>
            </div>
          </div>
          
          <div class="metric-card">
            <div class="metric-icon">
              <i class="fas fa-stopwatch"></i>
            </div>
            <div class="metric-content">
              <span class="metric-value">{{ formatExecutionTime(selectedAgent.executionMetrics.averageExecutionTime) }}</span>
              <span class="metric-label">Tempo M√©dio</span>
            </div>
          </div>
          
          <div class="metric-card" *ngIf="selectedAgent.executionMetrics.lastExecutionTime">
            <div class="metric-icon">
              <i class="fas fa-history"></i>
            </div>
            <div class="metric-content">
              <span class="metric-value">{{ formatLastExecution(selectedAgent.executionMetrics.lastExecutionTime) }}</span>
              <span class="metric-label">√öltima Execu√ß√£o</span>
            </div>
          </div>
        </div>
        
        <div class="metrics-footer">
          <div class="performance-bar">
            <div class="performance-fill" [style.width.%]="getPerformancePercentage(selectedAgent.executionMetrics)"></div>
            <div class="performance-shimmer" [class.active]="selectedAgent.executionMetrics.isCurrentlyExecuting"></div>
          </div>
          <div class="performance-text">
            <span>Efici√™ncia: {{ getPerformancePercentage(selectedAgent.executionMetrics) }}%</span>
            <span class="performance-trend" [class.positive]="getPerformanceTrend(selectedAgent.executionMetrics) > 0">
              <i class="fas" [class.fa-arrow-up]="getPerformanceTrend(selectedAgent.executionMetrics) > 0" 
                         [class.fa-arrow-down]="getPerformanceTrend(selectedAgent.executionMetrics) < 0"
                         [class.fa-minus]="getPerformanceTrend(selectedAgent.executionMetrics) === 0"></i>
              {{ getPerformanceTrend(selectedAgent.executionMetrics) > 0 ? '+' : '' }}{{ getPerformanceTrend(selectedAgent.executionMetrics) }}%
            </span>
          </div>
        </div>
        
        <!-- Se√ß√£o de Estat√≠sticas Avan√ßadas -->
        <div class="advanced-stats" *ngIf="showAdvancedStats">
          <div class="stats-header">
            <i class="fas fa-chart-bar"></i>
            <span>Estat√≠sticas Avan√ßadas</span>
            <button class="stats-toggle" (click)="toggleAdvancedStats()">
              <i class="fas fa-chevron-up"></i>
            </button>
          </div>
          <div class="stats-content">
            <div class="stat-item">
              <span class="stat-label">Taxa de Sucesso:</span>
              <span class="stat-value">{{ getSuccessRate(selectedAgent.executionMetrics) }}%</span>
            </div>
            <div class="stat-item">
              <span class="stat-label">Tempo de Ciclo:</span>
              <span class="stat-value">{{ getCycleTime(selectedAgent.executionMetrics) }}</span>
            </div>
            <div class="stat-item">
              <span class="stat-label">Produtividade:</span>
              <span class="stat-value">{{ getProductivity(selectedAgent.executionMetrics) }}</span>
            </div>
          </div>
        </div>

        <div class="metrics-actions">
          <button
            class="btn-test"
            (click)="testAgentExecution(selectedAgent.id)"
            [disabled]="selectedAgent.executionMetrics.isCurrentlyExecuting">
            <i class="fas fa-play" [class.fa-spin]="selectedAgent.executionMetrics.isCurrentlyExecuting"></i>
            {{ selectedAgent.executionMetrics.isCurrentlyExecuting ? 'Executando...' : 'Testar Execu√ß√£o' }}
          </button>
          <button class="btn-reset" (click)="resetAgentMetrics(selectedAgent.id)">
            <i class="fas fa-undo"></i>
            Resetar
          </button>
          <button class="btn-stats" (click)="toggleAdvancedStats()">
            <i class="fas fa-chart-bar"></i>
            {{ showAdvancedStats ? 'Ocultar' : 'Mostrar' }} Stats
          </button>
        </div>
      </div>
    </div>
    </div>
  </div>
</div>

<div class="dashboard-backdrop" (click)="onClose()">
  <div class="dashboard-container" (click)="$event.stopPropagation()">
    <!-- Header -->
    <div class="dashboard-header">
      <div class="header-content">
        <h2>üèõÔ∏è Conselho</h2>
        <p class="subtitle">Conselheiros ativos monitorando o projeto</p>
      </div>
      <div class="header-actions">
        <button class="icon-btn refresh-btn" (click)="refresh()" title="Recarregar" [disabled]="isLoading">
          üîÑ
        </button>
        <button class="close-btn" (click)="onClose()" title="Fechar">√ó</button>
      </div>
    </div>

    <!-- Body -->
    <div class="dashboard-body">
      <!-- Loading State -->
      <div *ngIf="isLoading" class="loading-state">
        <div class="spinner"></div>
        <p>Carregando conselheiros...</p>
      </div>

      <!-- Error State -->
      <div *ngIf="errorMessage && !isLoading" class="error-state">
        <div class="error-content">
          <span class="error-icon">‚ùå</span>
          <p>{{ errorMessage }}</p>
          <button class="btn btn-small" (click)="clearError()">Fechar</button>
        </div>
      </div>

      <!-- Empty State -->
      <div *ngIf="!isLoading && councilors.length === 0 && !errorMessage" class="empty-state">
        <div class="empty-icon">üèõÔ∏è</div>
        <h3>Nenhum conselheiro ativo</h3>
        <p>Promova um agente para conselheiro e configure tarefas automaticas de monitoramento.</p>
        <button class="btn btn-primary" (click)="onPromoteNew()">
          ‚≠ê Promover Primeiro Conselheiro
        </button>
      </div>

      <!-- Councilors List -->
      <div *ngIf="!isLoading && councilors.length > 0" class="councilors-list">
        <div
          *ngFor="let councilor of councilors"
          class="councilor-card"
          [ngClass]="getStatusClass(councilor)"
        >
          <!-- Card Header -->
          <div class="card-header">
            <div class="councilor-info">
              <div class="councilor-avatar">
                <span class="avatar-emoji">{{ councilor.emoji }}</span>
                <span class="status-badge" [title]="getStatusText(councilor)">{{ getStatusEmoji(councilor) }}</span>
              </div>
              <div class="councilor-details">
                <h3>{{ councilor.customization?.display_name || councilor.name }}</h3>
                <p class="role">{{ councilor.councilor_config?.title }}</p>
              </div>
            </div>
            <div class="card-actions">
              <!-- Executar Agora -->
              <button
                class="icon-btn execute-btn"
                (click)="executeNow(councilor)"
                [title]="isActionInProgress(councilor.agent_id) ? getActionInProgress(councilor.agent_id) : 'Executar Agora'"
                [disabled]="isActionInProgress(councilor.agent_id)"
                [class.executing]="isActionInProgress(councilor.agent_id)"
              >
                {{ isActionInProgress(councilor.agent_id) ? '‚è≥' : 'üöÄ' }}
              </button>
              <!-- Ver Relatorio -->
              <button
                class="icon-btn"
                (click)="viewLastReport(councilor)"
                title="Ver Ultimo Relatorio"
                [disabled]="isActionInProgress(councilor.agent_id)"
              >
                üìã
              </button>
              <!-- Editar -->
              <button
                class="icon-btn"
                (click)="editCouncilor(councilor)"
                title="Editar Configuracao"
                [disabled]="isActionInProgress(councilor.agent_id)"
              >
                ‚öôÔ∏è
              </button>
              <!-- Pausar/Retomar -->
              <button
                *ngIf="councilor.councilor_config?.schedule?.enabled"
                class="icon-btn"
                (click)="pauseCouncilor(councilor)"
                title="Pausar"
                [disabled]="isActionInProgress(councilor.agent_id)"
              >
                ‚è∏Ô∏è
              </button>
              <button
                *ngIf="councilor.councilor_config?.schedule && !councilor.councilor_config?.schedule?.enabled"
                class="icon-btn"
                (click)="resumeCouncilor(councilor)"
                title="Retomar"
                [disabled]="isActionInProgress(councilor.agent_id)"
              >
                ‚ñ∂Ô∏è
              </button>
            </div>
          </div>

          <!-- Action In Progress Indicator -->
          <div *ngIf="isActionInProgress(councilor.agent_id)" class="action-progress">
            <div class="progress-bar"></div>
            <span class="progress-text">{{ getActionInProgress(councilor.agent_id) }}</span>
          </div>

          <!-- Card Body -->
          <div class="card-body">
            <!-- Task Info -->
            <div class="task-info">
              <div class="info-item">
                <span class="label">Tarefa:</span>
                <span class="value">{{ councilor.councilor_config?.task?.name || 'N/A' }}</span>
              </div>
              <div class="info-item">
                <span class="label">Ultima execucao:</span>
                <span class="value">
                  {{ formatRelativeTime(councilor.stats?.last_execution) }}
                </span>
              </div>
              <div class="info-item">
                <span class="label">Proxima execucao:</span>
                <span class="value" [class.paused]="!councilor.councilor_config?.schedule?.enabled">
                  {{ getNextExecution(councilor) }}
                </span>
              </div>
            </div>

            <!-- Stats -->
            <div class="stats-row">
              <div class="stat-item">
                <div class="stat-value">{{ councilor.stats?.total_executions || 0 }}</div>
                <div class="stat-label">Execucoes</div>
              </div>
              <div class="stat-item">
                <div class="stat-value" [class.success]="(councilor.stats?.success_rate || 0) >= 90" [class.warning]="(councilor.stats?.success_rate || 0) >= 70 && (councilor.stats?.success_rate || 0) < 90" [class.error]="(councilor.stats?.success_rate || 0) < 70 && councilor.stats?.total_executions">
                  {{ (councilor.stats?.success_rate || 0).toFixed(0) }}%
                </div>
                <div class="stat-label">Taxa de Sucesso</div>
              </div>
              <div class="stat-item">
                <div class="stat-value">
                  {{ councilor.councilor_config?.schedule?.value || 'N/A' }}
                </div>
                <div class="stat-label">Intervalo</div>
              </div>
            </div>
          </div>

          <!-- Card Footer -->
          <div class="card-footer">
            <button
              class="btn-text btn-danger"
              (click)="demoteCouncilor(councilor)"
              [disabled]="isActionInProgress(councilor.agent_id)"
            >
              üîª Remover do Conselho
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <div class="dashboard-footer">
      <div class="footer-info">
        <span>{{ councilors.length }} conselheiro(s) ativo(s)</span>
      </div>
      <button class="btn btn-secondary" (click)="onPromoteNew()">
        ‚≠ê Promover Novo Conselheiro
      </button>
    </div>

    <!-- Modals -->
    <app-councilor-report-modal
      *ngIf="showReportModal"
      [isVisible]="showReportModal"
      [report]="selectedReport"
      [councilorName]="selectedCouncilor?.customization?.display_name || selectedCouncilor?.name || ''"
      (close)="closeReportModal()"
      (closeModal)="closeReportModal()"
    ></app-councilor-report-modal>

    <app-councilor-edit-modal
      *ngIf="showEditModal"
      [isVisible]="showEditModal"
      [councilor]="selectedCouncilor"
      (closeModal)="closeEditModal()"
      (save)="saveCouncilorConfig($event)"
    ></app-councilor-edit-modal>
  </div>
</div>

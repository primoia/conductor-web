    <div class="screenplay-layout" [class.screenplay-modal-active]="screenplayModalOpen">
      <div class="screenplay-container" [class.first-column-hidden]="!firstColumnVisible">
        <!-- Coluna 1: Sistema de Abas -->
        <div class="first-column">
          <!-- Tab Navigation -->
          <div class="first-column-tabs">
            <button
              class="tab-button"
              [class.active]="activeTab === 'catalog'"
              (click)="setActiveTab('catalog')"
              title="CatÃ¡logo de Agentes">
              ğŸ¤– Agentes
            </button>
            <button
              class="tab-button"
              [class.active]="activeTab === 'instances'"
              (click)="setActiveTab('instances')"
              title="Agentes Instanciados">
              ğŸ­ InstÃ¢ncias
            </button>
            <button
              class="tab-button"
              [class.active]="activeTab === 'tree'"
              (click)="setActiveTab('tree')"
              title="Ãrvore de Roteiros">
              ğŸ¬ Roteiros
            </button>
          </div>

          <!-- Tab Content -->
          <div class="first-column-content">
            <!-- Aba 1: Ãrvore de Roteiros -->
            <app-screenplay-tree
              *ngIf="activeTab === 'tree'"
              [screenplays]="screenplaysList"
              [activeScreenplayId]="currentScreenplay?.id || null"
              (openScreenplay)="onTreeScreenplayOpen($event)"
              (updateScreenplay)="onTreeUpdateScreenplay($event)"
              (reloadFromDisk)="onTreeReload($event)">
            </app-screenplay-tree>

            <!-- Aba 2: Agentes Instanciados (jÃ¡ existe) -->
            <app-agent-game
              *ngIf="activeTab === 'instances'"
              #agentGame>
            </app-agent-game>

            <!-- Aba 3: CatÃ¡logo de Agentes -->
            <app-agent-catalog
              *ngIf="activeTab === 'catalog'"
              (selectAgent)="onCatalogAgentSelect($event)"
              (createAgent)="openAgentCreatorFromCatalog()">
            </app-agent-catalog>
          </div>
        </div>

        <div class="screenplay-canvas" #canvas>
          <!-- Editor Toolbar movida para cima da coluna do meio -->
          <div class="editor-toolbar">
            <!-- Loading indicator -->
            <div *ngIf="isLoading" class="toolbar-loading">
              <span>Carregando...</span>
            </div>
            <input type="file" #fileInput hidden (change)="handleFileSelect($event)" accept=".md" />

            <!-- Toolbar Buttons -->
            <div class="toolbar-buttons">
              <!-- Mobile Close Button (only visible on mobile when screenplay is open) -->
              <button
                class="toolbar-btn close-screenplay-btn"
                title="Fechar Roteiro"
                (click)="closeScreenplayModal()">
                âœ•
              </button>
              <button
                class="toolbar-btn new-btn"
                title="Novo Roteiro"
                (click)="newScreenplayWithDefaultAgent()">
                ğŸ“„
              </button>
              <button
                class="toolbar-btn open-btn"
                title="Abrir do Banco..."
                (click)="openScreenplayManager()">
                ğŸ“‚
              </button>
              <button
                class="toolbar-btn save-btn-toolbar"
                [class.saving]="isSaving"
                [class.dirty]="isDirty"
                [title]="isSaving ? 'Salvando...' : (isDirty ? 'Salvar' : 'Salvo')"
                [disabled]="!isDirty"
                (click)="save()">
                ğŸ’¾
              </button>
              <button
                class="toolbar-btn import-btn"
                title="Importar do Disco..."
                (click)="importFromDisk()">
                ğŸ“¥
              </button>
              <button
                class="toolbar-btn export-btn"
                title="Exportar para Disco..."
                (click)="openExportModal()">
                ğŸ“¤
              </button>
              <!-- Conselheiros -->
              <button class="toolbar-btn" title="Conselheiros" (click)="openCouncilorsDashboard()" [attr.data-badge]="footerBadges.ministers?.count || null" [attr.data-badge-severity]="footerBadges.ministers?.severity">ğŸ›ï¸</button>

              <!-- ConfiguraÃ§Ãµes do Roteiro -->
              <button
                class="toolbar-btn settings-btn"
                #settingsButton
                title="ConfiguraÃ§Ãµes do Roteiro"
                (click)="toggleScreenplaySettings()">
                âš™ï¸
              </button>

              <!-- Settings Menu -->
              <div
                *ngIf="showScreenplaySettings"
                class="screenplay-settings-menu">
                <button class="menu-item" (click)="openWorkingDirModal()">
                  ğŸ“ Configurar DiretÃ³rio de Trabalho
                </button>
                <button class="menu-item" (click)="toggleScreenplayInfoModal(); showScreenplaySettings = false">
                  âŒ¨ï¸ Atalhos de Teclado
                </button>
              </div>
            </div>
          </div>

          <div class="editor-content">
            <app-interactive-editor
              [content]="editorContent"
              [placeholder]="'Digite / para comandos ou comece a escrever o seu roteiro vivo...'"
              (contentChange)="handleContentUpdate($event)"
              (blockCommand)="onBlockCommand($event)">
            </app-interactive-editor>
          </div>
        </div>


        <!-- DISABLED: Visual agent circles overlay
             Agents are still created and managed in MongoDB
             Access via the dock on the right side -->
        <!--
        <div class="overlay-elements" *ngIf="currentView !== 'clean'">
          <draggable-circle
            *ngFor="let agent of getAgentInstancesAsArray()"
            [data]="{ id: agent.id, emoji: agent.emoji, title: agent.definition.title, description: agent.definition.description, category: 'auth' }"
            [position]="agent.position"
            [container]="canvas"
            [attr.data-status]="agent.status"
            [class.agent-queued]="agent.status === 'queued'"
            [class.agent-running]="agent.status === 'running'"
            [class.agent-completed]="agent.status === 'completed'"
            [class.agent-error]="agent.status === 'error'"
            [title]="getAgentTooltip(agent)"
            (circleEvent)="onAgentInstanceCircleEvent($event, agent)"
            (positionChange)="onAgentInstancePositionChange($event, agent)">
          </draggable-circle>

          <div
            *ngFor="let agent of getAgentInstancesAsArray()"
            class="agent-badge"
            [style.left.px]="agent.position.x + 50"
            [style.top.px]="agent.position.y - 10">
            <div class="cwd-badge" *ngIf="agent.config?.cwd" [title]="agent.config?.cwd || ''">
              ğŸ“ {{ getAgentCwdDisplay(agent) }}
            </div>
          </div>
        </div>
        -->
      </div>

      <!-- Popup para hover -->
      <div class="action-popup"
           *ngIf="popupVisible"
           [style.left.px]="popupX"
           [style.top.px]="popupY">
        {{ popupText }}
        <div class="popup-arrow"></div>
      </div>

      <!-- Agent Creator Modal -->
      <app-agent-creator
        [isVisible]="showAgentCreator"
        (agentCreated)="onAgentCreated($event)"
        (close)="closeAgentCreator()">
      </app-agent-creator>

      <!-- Agent Selector Modal -->
      <app-agent-selector-modal
        [isVisible]="showAgentSelector"
        [screenplayWorkingDirectory]="currentWorkingDirectory"
        (agentSelected)="onAgentSelected($event)"
        (close)="closeAgentSelector()">
      </app-agent-selector-modal>

      <!-- Agent Preview Modal -->
      <app-agent-preview-modal
        [isVisible]="showAgentPreview"
        [previewData]="previewData"
        [isLoading]="previewLoading"
        [error]="previewError"
        (accept)="onPreviewAccept($event)"
        (reject)="onPreviewReject($event)"
        (close)="closeAgentPreview()">
      </app-agent-preview-modal>

      <!-- Screenplay Manager Modal -->
      <app-screenplay-manager
        [isVisible]="showScreenplayManager"
        (close)="closeScreenplayManager()"
        (action)="onScreenplayManagerAction($event)">
      </app-screenplay-manager>

      <!-- Export Modal -->
      <app-export-modal
        [isVisible]="showExportModal"
        [filename]="defaultExportFilename"
        (closeModal)="closeExportModal()"
        (export)="confirmExport($event)">
      </app-export-modal>

      <!-- Third Column: Chat + Footer -->
      <div class="third-column">
        <!-- Chat Panel with Agent Dock -->
        <div class="chat-panel">
          <app-conductor-chat
            #conductorChat
            [contextualAgents]="contextualAgents"
            [screenplayWorkingDirectory]="currentWorkingDirectory"
            [firstColumnVisible]="firstColumnVisible"
            (addAgentRequested)="openAgentSelector()"
            (deleteAgentRequested)="onDeleteAgentClick()"
            (openScreenplayModalRequested)="openScreenplayModal()"
            (agentDockClicked)="onDockAgentClick($event)"
            (activeConversationChanged)="onActiveConversationChanged($event)"
            (agentOrderChanged)="onAgentOrderChanged($event)"
            (toggleFirstColumnRequested)="toggleFirstColumn()">
          </app-conductor-chat>
        </div>
      </div>

      <!-- Events Column: Agent News (right of chat) -->
      <div class="events-column">
        <div class="events-column-header">
          <span class="events-title">ğŸ“° NotÃ­cias dos Agentes</span>
        </div>
        <div class="events-column-content">
          <app-event-ticker
            [isExpanded]="true"
            (select)="onTickerSelect($event)"
            (investigate)="onTickerInvestigate($event)">
          </app-event-ticker>
        </div>
      </div>
    </div>

    <!-- ğŸ”¥ NOVO: BotÃ£o fechar modal de screenplay (mobile) -->
    <button
      class="close-screenplay-modal"
      (click)="closeScreenplayModal()"
      title="Fechar Roteiro">
      âœ•
    </button>

    <!-- Delete Confirmation Modal -->
    <div class="modal-backdrop" *ngIf="showDeleteConfirmModal" (click)="closeDeleteConfirmModal()">
      <div class="modal-content delete-confirm-modal" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h3>ğŸ—‘ï¸ Excluir Agente</h3>
          <button class="close-btn" (click)="closeDeleteConfirmModal()">Ã—</button>
        </div>

        <div class="modal-body">
          <!-- Agent Info Display -->
          <div class="agent-display" *ngIf="agentToDelete">
            <div class="agent-emoji-large">{{ agentToDelete.emoji }}</div>
            <div class="agent-details">
              <div class="agent-name-large">{{ agentToDelete.definition.title }}</div>
              <div class="agent-description-large">{{ agentToDelete.definition.description || 'Sem descriÃ§Ã£o' }}</div>
            </div>
          </div>
        </div>

        <div class="modal-footer">
          <button class="btn btn-secondary" (click)="closeDeleteConfirmModal()">Cancelar</button>
          <button class="btn btn-danger" (click)="confirmDeleteAgent()">Excluir Agente</button>
        </div>
      </div>
    </div>

    <!-- UI Enhancement: Conflict Resolution Modal -->
    <app-conflict-resolution-modal
      [isVisible]="showConflictModal"
      [existingScreenplay]="conflictExistingScreenplay"
      [newFileName]="conflictNewFileName"
      [newContent]="conflictNewContent"
      (resolve)="handleConflictResolution($event)">
    </app-conflict-resolution-modal>

    <!-- Working Directory Modal -->
    <app-working-dir-modal
      [isVisible]="showWorkingDirModal"
      [currentDirectory]="currentWorkingDirectory"
      (closeModal)="closeWorkingDirModal()"
      (save)="saveWorkingDirectory($event)">
    </app-working-dir-modal>

    <!-- Screenplay Info Modal -->
    <app-screenplay-info-modal
      [isVisible]="showScreenplayInfoModal"
      (closeModal)="closeScreenplayInfoModal()">
    </app-screenplay-info-modal>

    <!-- UI Enhancement: Notification Toast -->
    <app-notification-toast></app-notification-toast>

      <!-- Fase 3: Report Modal -->
      <app-report-modal
        [isVisible]="showReportModal"
        [data]="reportData"
        (close)="closeReportModal()"
        (refresh)="refreshFromReport()"
      ></app-report-modal>

      <!-- Investigation Launcher Modal -->
      <app-investigation-launcher
        [isVisible]="showInvestigationModal"
        (close)="closeInvestigation()"
        (launchInvestigation)="launchInvestigation($event)"
      ></app-investigation-launcher>

      <!-- Agent Personalization Modal -->
      <app-agent-personalization-modal
        [isVisible]="showAgentPersonalization"
        (close)="closeAgentPersonalization()"
      ></app-agent-personalization-modal>

      <!-- Councilors Dashboard -->
      <app-councilors-dashboard
        *ngIf="showCouncilorsDashboard"
        (close)="closeCouncilorsDashboard()"
        (promoteNew)="openAgentSelectorForPromotion()"
      ></app-councilors-dashboard>

      <!-- Promote Councilor Modal -->
      <app-promote-councilor-modal
        *ngIf="showPromoteCouncilorModal"
        [agent]="selectedAgentForPromotion"
        (promote)="handlePromoteCouncilor($event)"
        (close)="closePromoteCouncilorModal()"
      ></app-promote-councilor-modal>

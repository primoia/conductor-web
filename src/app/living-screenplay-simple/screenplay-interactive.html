    <div class="screenplay-layout">
      <div class="screenplay-container" [style.width.%]="screenplayWidth">
        <div class="control-panel">
          <div class="panel-container">
            <app-agent-game #agentGame></app-agent-game>
          </div>
        </div>

      <div class="screenplay-canvas" #canvas>
        <!-- Editor Toolbar -->
        <div class="editor-toolbar">
          <!-- Loading indicator -->
          <div *ngIf="isLoading" class="toolbar-loading">
            <span>Carregando...</span>
          </div>
          <input type="file" #fileInput hidden (change)="handleFileSelect($event)" accept=".md,.txt" />

          <!-- Toolbar Buttons -->
          <div class="toolbar-buttons">
            <button
              class="toolbar-btn new-btn"
              title="Novo Roteiro"
              (click)="newScreenplayWithDefaultAgent()">
              üìÑ
            </button>
            <button
              class="toolbar-btn open-btn"
              title="Abrir do Banco..."
              (click)="openScreenplayManager()">
              üìÇ
            </button>
            <button
              class="toolbar-btn import-btn"
              title="Importar do Disco..."
              (click)="importFromDisk()">
              üì•
            </button>
            <button
              class="toolbar-btn save-btn-toolbar"
              [class.saving]="isSaving"
              [class.dirty]="isDirty"
              [title]="isSaving ? 'Salvando...' : (isDirty ? 'Salvar' : 'Salvo')"
              [disabled]="!isDirty"
              (click)="save()">
              üíæ
            </button>
            <button
              class="toolbar-btn export-btn"
              title="Exportar para Disco..."
              (click)="openExportModal()">
              üì§
            </button>
          </div>
        </div>

        <div class="editor-content">
          <app-interactive-editor
            [content]="editorContent"
            [placeholder]="'Digite / para comandos ou comece a escrever o seu roteiro vivo...'"
            (contentChange)="handleContentUpdate($event)"
            (blockCommand)="onBlockCommand($event)">
          </app-interactive-editor>
        </div>

        <!-- Editor Footer / Status Bar -->
        <div class="editor-footer">
          <div class="footer-section" *ngIf="sourceOrigin === 'database' && currentScreenplay">
            <span class="footer-icon">üìÑ</span>
            <span class="footer-filename">{{ currentScreenplay.name }}</span>
          </div>

          <div class="footer-section" *ngIf="sourceOrigin === 'new'">
            <span class="footer-icon">üìù</span>
            <span class="footer-filename">{{ sourceIdentifier || 'Novo Roteiro' }}</span>
            <span class="footer-badge new-badge">
              <span class="badge-icon">‚ú®</span>
              <span class="badge-text">N√£o salvo</span>
            </span>
          </div>

          <div class="footer-section footer-center">
            <span class="footer-shortcuts" title="Atalhos de teclado">
              <kbd>Ctrl+S</kbd> Salvar
              <span class="separator">‚Ä¢</span>
              <kbd>Ctrl+N</kbd> Novo
              <span class="separator">‚Ä¢</span>
              <kbd>Ctrl+O</kbd> Abrir
              <span class="separator">‚Ä¢</span>
              <kbd>Ctrl+Shift+A</kbd> Agente
            </span>
          </div>

          <div class="footer-section footer-right">
            <span class="footer-status" *ngIf="isSaving">
              <span class="status-spinner">‚è≥</span>
              Salvando...
            </span>
            <span class="footer-status modified" *ngIf="isDirty && !isSaving">
              <span class="status-indicator">‚óè</span>
              Modificado
            </span>
            <span class="footer-status saved" *ngIf="!isDirty && !isSaving && currentScreenplay">
              <span class="status-indicator">‚úì</span>
              Salvo
            </span>
          </div>
        </div>

        <!-- DISABLED: Visual agent circles overlay
             Agents are still created and managed in MongoDB
             Access via the dock on the right side -->
        <!--
        <div class="overlay-elements" *ngIf="currentView !== 'clean'">
          <draggable-circle
            *ngFor="let agent of getAgentInstancesAsArray()"
            [data]="{ id: agent.id, emoji: agent.emoji, title: agent.definition.title, description: agent.definition.description, category: 'auth' }"
            [position]="agent.position"
            [container]="canvas"
            [attr.data-status]="agent.status"
            [class.agent-queued]="agent.status === 'queued'"
            [class.agent-running]="agent.status === 'running'"
            [class.agent-completed]="agent.status === 'completed'"
            [class.agent-error]="agent.status === 'error'"
            [title]="getAgentTooltip(agent)"
            (circleEvent)="onAgentInstanceCircleEvent($event, agent)"
            (positionChange)="onAgentInstancePositionChange($event, agent)">
          </draggable-circle>

          <div
            *ngFor="let agent of getAgentInstancesAsArray()"
            class="agent-badge"
            [style.left.px]="agent.position.x + 50"
            [style.top.px]="agent.position.y - 10">
            <div class="cwd-badge" *ngIf="agent.config?.cwd" [title]="agent.config?.cwd || ''">
              üìÅ {{ getAgentCwdDisplay(agent) }}
            </div>
          </div>
        </div>
        -->
      </div>

      <!-- Popup para hover -->
      <div class="action-popup"
           *ngIf="popupVisible"
           [style.left.px]="popupX"
           [style.top.px]="popupY">
        {{ popupText }}
        <div class="popup-arrow"></div>
      </div>

      <!-- Agent Creator Modal -->
      <app-agent-creator
        [isVisible]="showAgentCreator"
        (agentCreated)="onAgentCreated($event)"
        (close)="closeAgentCreator()">
      </app-agent-creator>

      <!-- Agent Selector Modal -->
      <app-agent-selector-modal
        [isVisible]="showAgentSelector"
        (agentSelected)="onAgentSelected($event)"
        (close)="closeAgentSelector()">
      </app-agent-selector-modal>

      <!-- Agent Preview Modal -->
      <app-agent-preview-modal
        [isVisible]="showAgentPreview"
        [previewData]="previewData"
        [isLoading]="previewLoading"
        [error]="previewError"
        (accept)="onPreviewAccept($event)"
        (reject)="onPreviewReject($event)"
        (close)="closeAgentPreview()">
      </app-agent-preview-modal>

      <!-- Screenplay Manager Modal -->
      <app-screenplay-manager
        [isVisible]="showScreenplayManager"
        (close)="closeScreenplayManager()"
        (action)="onScreenplayManagerAction($event)">
      </app-screenplay-manager>

      <!-- Export Modal -->
      <div class="modal-overlay" *ngIf="showExportModal" (click)="closeExportModal()">
        <div class="export-modal" (click)="$event.stopPropagation()">
          <div class="modal-header">
            <h3>üì§ Exportar Roteiro para Disco</h3>
            <button class="close-btn" (click)="closeExportModal()">√ó</button>
          </div>
          <div class="modal-body">
            <div class="form-group">
              <label for="export-filename">Nome do arquivo:</label>
              <input
                type="text"
                id="export-filename"
                [(ngModel)]="exportFilename"
                placeholder="roteiro-vivo.md"
                class="filename-input"
                (keydown.enter)="confirmExport()"
              />
              <small class="hint">Voc√™ poder√° escolher onde salvar o arquivo</small>
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn-cancel" (click)="closeExportModal()">Cancelar</button>
            <button class="btn-export" (click)="confirmExport()">Escolher Local e Exportar</button>
          </div>
        </div>
      </div>
      </div>

      <!-- Resizable splitter -->
      <div class="splitter" (mousedown)="onSplitterMouseDown($event)"></div>

      <!-- Chat component -->
      <div class="chat-panel" [style.width.%]="chatWidth">
        <app-conductor-chat #conductorChat></app-conductor-chat>
      </div>

      <!-- Agent Launcher Dock -->
      <div class="agent-launcher-dock">
        <div class="dock-section">
          <div class="dock-section-title">Agents</div>

          <!-- Add Agent Button -->
          <button
            class="dock-item add-agent-dock-btn"
            title="Adicionar Agente"
            (click)="openAgentSelector()">
            ‚ûï
          </button>

          <div class="dock-separator"></div>

          <!-- Agent List -->
          <button
            *ngFor="let agent of contextualAgents"
            class="dock-item"
            [class.active]="activeAgentId === agent.id"
            [title]="agent.definition.description"
            (click)="onDockAgentClick(agent)">
            {{ agent.emoji }}
          </button>
        </div>
      </div>
    </div>

<!--
  ============================================================
  AGENT SELECTOR MODAL - NORMALIZADO
  ============================================================
  âœ“ Estrutura padronizada (backdrop + container)
  âœ“ GestÃ£o de visibilidade via *ngIf
  âœ“ Eventos de fechamento padronizados
  âœ“ Accessibility (ARIA) aplicado
  âœ“ Classes CSS normalizadas
  Data de normalizaÃ§Ã£o: 2025-11-08
  ============================================================
-->
<div class="modal-backdrop" *ngIf="isVisible" (click)="onBackdropClick($event)">
  <div class="modal-container" (click)="$event.stopPropagation()" role="dialog" aria-modal="true" aria-labelledby="modal-title">

    <app-modal-header
      [title]="'ğŸ¤– Selecionar Agente'"
      [showCloseButton]="true"
      (close)="onClose()"
      aria-label="CabeÃ§alho do modal de seleÃ§Ã£o de agente">
    </app-modal-header>

    <!-- Search bar and sort controls -->
    <div class="search-sort-container" *ngIf="!isLoading && !error">
      <div class="search-container">
        <input
          #searchInput
          type="text"
          class="search-input"
          [(ngModel)]="searchQuery"
          (ngModelChange)="onSearchChange()"
          placeholder="ğŸ” Buscar agente por nome..."
          aria-label="Buscar agente por nome"
          autofocus>
        <button
          *ngIf="searchQuery"
          class="clear-search"
          (click)="clearSearch()"
          aria-label="Limpar busca">Ã—</button>
      </div>
      <div class="sort-container">
        <label for="sortSelect" class="sort-label">Ordenar:</label>
        <select
          id="sortSelect"
          class="sort-select"
          [ngModel]="currentSort"
          (ngModelChange)="onSortChange($event)"
          aria-label="Ordenar lista de agentes">
          <option *ngFor="let option of sortOptions" [value]="option.value">
            {{ option.label }}
          </option>
        </select>
      </div>
    </div>

    <!-- Group filter chips -->
    <div class="group-filter-container" *ngIf="!isLoading && !error">
      <div class="group-chips" role="radiogroup" aria-label="Filtrar por grupo">
        <button
          *ngFor="let group of groupOptions"
          class="group-chip"
          [class.active]="currentGroup === group.value"
          (click)="onGroupChange(group.value)"
          type="button"
          role="radio"
          [attr.aria-checked]="currentGroup === group.value"
          [attr.aria-label]="group.label + (group.count !== undefined ? ' (' + group.count + ' agentes)' : '')">
          {{ group.label }}
          <span class="group-count" *ngIf="group.count !== undefined">({{ group.count }})</span>
        </button>
      </div>
    </div>

    <div class="modal-body">
      <!-- Loading state -->
      <div *ngIf="isLoading" class="loading-state" role="status" aria-live="polite">
        <div class="spinner" aria-hidden="true"></div>
        <p>Carregando agentes disponÃ­veis...</p>
      </div>

      <!-- Error state -->
      <div *ngIf="error && !isLoading" class="error-state" role="alert">
        <div class="error-icon" aria-hidden="true">âš ï¸</div>
        <p>{{ error }}</p>
        <button class="retry-btn" (click)="loadAgents()">ğŸ”„ Tentar Novamente</button>
      </div>

      <!-- Agents list -->
      <div *ngIf="!isLoading && !error" class="agents-list" (scroll)="onListScroll()">
        <div *ngIf="filteredAgents.length === 0 && agents.length > 0" class="empty-state" role="status">
          <div class="empty-icon" aria-hidden="true">ğŸ”</div>
          <p>Nenhum agente encontrado</p>
          <small>Tente outra busca</small>
        </div>

        <div *ngIf="agents.length === 0" class="empty-state" role="status">
          <div class="empty-icon" aria-hidden="true">ğŸ¤·</div>
          <p>Nenhum agente disponÃ­vel</p>
          <small>Crie agentes usando o CLI do Conductor</small>
        </div>

        <div
          *ngFor="let agent of filteredAgents; trackBy: trackByAgentId"
          class="agent-item"
          [class.disabled]="isScrolling"
          (click)="selectAgent(agent)"
          (keydown.enter)="selectAgent(agent)"
          [title]="isScrolling ? 'Aguarde o scroll parar...' : agent.description"
          role="button"
          tabindex="0"
          [attr.aria-label]="'Selecionar agente: ' + agent.name">
          <div class="agent-emoji" aria-hidden="true">{{ agent.emoji }}</div>
          <div class="agent-info">
            <div class="agent-name">{{ agent.name }}</div>
            <div class="agent-description">{{ agent.description }}</div>
          </div>
          <div class="select-indicator" aria-hidden="true">{{ isScrolling ? 'â³' : 'â†’' }}</div>
        </div>
      </div>
    </div>

    <!-- Advanced Settings (collapsible) -->
    <div class="advanced-settings" *ngIf="!isLoading && !error">
      <button
        class="advanced-toggle"
        (click)="toggleAdvancedSettings()"
        type="button"
        [attr.aria-expanded]="showAdvancedSettings"
        aria-controls="advanced-content">
        <span class="toggle-icon" aria-hidden="true">{{ showAdvancedSettings ? 'â–¼' : 'â–¶' }}</span>
        âš™ï¸ ConfiguraÃ§Ãµes avanÃ§adas
      </button>

      <div
        id="advanced-content"
        class="advanced-content"
        *ngIf="showAdvancedSettings"
        [@slideDown]>
        <div class="form-group">
          <label for="cwdInput">ğŸ“ DiretÃ³rio de trabalho (opcional)</label>
          <input
            id="cwdInput"
            type="text"
            class="cwd-input"
            [(ngModel)]="workingDirectory"
            placeholder="/mnt/ramdisk/projeto-exemplo"
            (keydown.enter)="$event.preventDefault()"
            aria-label="DiretÃ³rio de trabalho">
          <small class="help-text">Define onde o agente executarÃ¡ os comandos</small>
        </div>

        <div class="recent-dirs" *ngIf="recentDirectories.length > 0">
          <small class="recent-label">DiretÃ³rios recentes:</small>
          <div class="dir-chips">
            <button
              *ngFor="let dir of recentDirectories"
              class="dir-chip"
              (click)="selectDirectory(dir)"
              type="button"
              [attr.aria-label]="'Selecionar diretÃ³rio: ' + dir">
              ğŸ“‚ {{ dir }}
            </button>
          </div>
        </div>
      </div>
    </div>

    <app-modal-footer
      *ngIf="!isLoading && !error && agents.length > 0"
      [buttons]="footerButtons"
      (buttonClick)="handleFooterAction($event)"
      aria-label="AÃ§Ãµes do modal">
    </app-modal-footer>

  </div>
</div>

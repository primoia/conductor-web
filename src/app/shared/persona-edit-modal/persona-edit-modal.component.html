<!-- Persona Edit Modal Template -->
<div class="persona-edit-modal">
  <div class="modal-backdrop" *ngIf="isVisible" (click)="onBackdropClick($event)">
    <div class="modal-container" (click)="$event.stopPropagation()" (touchstart)="$event.stopPropagation()" (touchend)="$event.stopPropagation()">

      <!-- Header -->
      <div class="modal-header">
        <h3 class="modal-title">Editar Agente</h3>
        <button class="close-btn" (click)="close()">âœ•</button>
      </div>

      <!-- Modal Body -->
      <div class="modal-body">
        <!-- CWD Section -->
        <div class="cwd-section">
          <label class="cwd-label">Diretorio de trabalho (CWD)</label>

          <!-- Inherited from screenplay (read-only display) -->
          <div class="cwd-inherited" *ngIf="screenplayWorkingDirectory">
            <span class="cwd-inherited-icon">ðŸ“‚</span>
            <span class="cwd-inherited-path">{{ screenplayWorkingDirectory }}</span>
            <span class="cwd-inherited-badge">roteiro</span>
          </div>
          <small class="cwd-hint cwd-hint-warn" *ngIf="!screenplayWorkingDirectory">
            Nenhum CWD configurado no roteiro. Configure nas propriedades do roteiro.
          </small>

          <!-- Override toggle -->
          <label class="cwd-override-toggle" *ngIf="screenplayWorkingDirectory">
            <input
              type="checkbox"
              [checked]="!!agentCwd"
              (change)="toggleCwdOverride($event)">
            <span class="cwd-override-label">Usar caminho diferente para este agente</span>
          </label>

          <!-- Override input (only when overriding) -->
          <input
            *ngIf="agentCwd || !screenplayWorkingDirectory"
            type="text"
            class="cwd-input"
            [(ngModel)]="cwdText"
            [placeholder]="screenplayWorkingDirectory || '/caminho/do/projeto'"
            inputmode="url">
        </div>

        <div class="editor-container">
          <!-- Editor Tabs -->
          <div class="editor-tabs">
            <button
              class="tab"
              [class.active]="activeTab === 'edit'"
              (click)="setActiveTab('edit')">
              Editar
            </button>
            <button
              class="tab"
              [class.active]="activeTab === 'preview'"
              (click)="setActiveTab('preview')">
              Preview
            </button>
          </div>

          <!-- Editor Content -->
          <div class="editor-content">
            <!-- Edit Tab -->
            <textarea
              *ngIf="activeTab === 'edit'"
              [(ngModel)]="personaText"
              (input)="onTextChange()"
              placeholder="Digite a persona do agente..."
              class="persona-textarea"
              inputmode="text"
              [maxlength]="maxLength"
              [class.error]="validationState.errors.length > 0"
              (touchend)="$event.stopPropagation()">
            </textarea>

            <!-- Preview Tab -->
            <div
              *ngIf="activeTab === 'preview'"
              class="persona-preview"
              [innerHTML]="getPreviewHtml()">
            </div>
          </div>

          <!-- OpÃ§Ã£o de persistÃªncia -->
          <div class="persistence-option">
            <label class="checkbox-container">
              <input
                type="checkbox"
                [(ngModel)]="saveToDatabase">
              <span class="checkmark"></span>
              <span class="checkbox-label">Salvar permanentemente no banco de dados</span>
            </label>
            <small class="persistence-hint">
              {{ saveToDatabase ? 'A persona serÃ¡ atualizada no template base (collection agents)' : 'A ediÃ§Ã£o serÃ¡ salva apenas localmente neste navegador' }}
            </small>
          </div>

          <!-- Validation info -->
          <div class="editor-info">
            <span
              class="char-count"
              [class.warning]="personaText.length > maxLength * 0.8"
              [class.error]="personaText.length > maxLength">
              {{ personaText.length }}/{{ maxLength }}
            </span>
            <span class="save-status" [class]="saveState.status" *ngIf="saveState.status !== 'idle'">
              {{ getSaveStatusText() }}
            </span>
          </div>
        </div>
      </div>

      <!-- Footer -->
      <div class="modal-footer-bar">
        <button class="btn-cancel" (click)="close()">Cancelar</button>
        <button
          class="btn-save"
          (click)="save()"
          [disabled]="!validationState.isValid || saveState.status === 'saving'">
          {{ saveState.status === 'saving' ? 'Salvando...' : 'Salvar' }}
        </button>
      </div>
    </div>
  </div>
</div>
